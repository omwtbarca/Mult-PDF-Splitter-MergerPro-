<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Master Workshop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        .page-card { transition: all 0.2s; }
        .page-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #3b82f6; }
        .file-item.active { background-color: #eff6ff; border-color: #3b82f6; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 pb-20">

    <div class="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight flex items-center gap-3">
                    <span data-i18n="title">PDF Master Workshop</span>
                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-normal" data-i18n="tag_local">Client-side Only</span>
                </h1>
                <p class="text-xs text-slate-500 mt-0.5" data-i18n="subtitle">Multi-file mixing ¬∑ Real-time preview ¬∑ Privacy focused</p>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="toggleLanguage()" class="text-xs font-medium text-slate-500 hover:text-blue-600 border border-slate-200 px-3 py-2 rounded-lg hover:bg-slate-50 transition">
                    üåê English / ‰∏≠Êñá
                </button>

                <label class="bg-slate-900 hover:bg-slate-800 text-white text-sm font-medium px-5 py-2.5 rounded-lg cursor-pointer transition shadow hover:shadow-lg flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    <span data-i18n="btn_add">Add PDF Files</span>
                    <input type="file" id="file-input" accept=".pdf" multiple class="hidden">
                </label>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-100px)]">
        
        <div class="lg:col-span-4 flex flex-col gap-4 h-full overflow-hidden">
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col flex-1 min-h-0">
                <div class="p-3 border-b border-slate-100 bg-slate-50 rounded-t-xl flex justify-between items-center">
                    <h2 class="font-bold text-slate-700 text-sm" data-i18n="header_sources">Source Files (Click to Preview)</h2>
                    <span id="file-count" class="text-xs text-slate-400">0 files</span>
                </div>
                <div id="file-list" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scroll">
                    <div class="text-center text-slate-400 py-10 text-sm">
                        <span data-i18n="empty_list">Please add PDF files<br>from the top right button</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 shrink-0">
                
                <div class="mb-3">
                    <label class="flex justify-between text-sm font-bold text-slate-700 mb-1">
                        <span data-i18n="label_instruction">Layout Instructions</span>
                        <span class="text-xs font-normal text-blue-600 cursor-pointer hover:underline" onclick="clearInput()" data-i18n="action_clear">Clear</span>
                    </label>
                    <textarea id="page-range" rows="3" placeholder="e.g. A1-3; B1; A5,B2" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-mono resize-none bg-slate-50"></textarea>
                    
                    <div class="mt-2 text-[11px] text-slate-500 bg-slate-50 p-2 rounded border border-slate-100 leading-relaxed">
                        <span class="font-bold text-slate-700" data-i18n="guide_title">Syntax Guide:</span><br>
                        ‚Ä¢ <code class="bg-white border px-1 rounded text-red-500">;</code> <span data-i18n="guide_semicolon">Semicolon: Separates output files (ZIP mode)</span><br>
                        ‚Ä¢ <code class="bg-white border px-1 rounded text-blue-600">A1-5</code> <span data-i18n="guide_range">Pages 1-5 of File A</span><br>
                        ‚Ä¢ <span data-i18n="guide_example">Ex: A1-3; B1 (Creates 2 parts)</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <label class="border rounded-lg p-2 flex flex-col items-center cursor-pointer hover:bg-slate-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 transition">
                        <input type="radio" name="mode" value="merge" checked class="mb-1 text-blue-600">
                        <span class="text-xs font-bold text-slate-700" data-i18n="mode_merge">Merge to Single PDF</span>
                        <span class="text-[10px] text-slate-400" data-i18n="mode_merge_desc">Ignore semicolons, combine all</span>
                    </label>
                    <label class="border rounded-lg p-2 flex flex-col items-center cursor-pointer hover:bg-slate-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 transition">
                        <input type="radio" name="mode" value="split" class="mb-1 text-blue-600">
                        <span class="text-xs font-bold text-slate-700" data-i18n="mode_split">Split by Semicolon (ZIP)</span>
                        <span class="text-[10px] text-slate-400" data-i18n="mode_split_desc">Each group becomes a file</span>
                    </label>
                </div>

                <div class="mb-3">
                     <input type="text" id="custom-filename" placeholder="Filename Prefix (Optional)" class="w-full border-b border-slate-300 px-1 py-1 text-sm focus:border-blue-500 outline-none bg-transparent">
                </div>

                <button id="process-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                    <span data-i18n="btn_process">Start Processing</span>
                </button>
                <div id="status-msg" class="text-center text-xs mt-2 min-h-[1.5em] text-slate-500 font-medium"></div>
            </div>
        </div>

        <div class="lg:col-span-8 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-full overflow-hidden relative">
            
            <div class="px-5 py-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2">
                    <h2 class="font-bold text-slate-700" data-i18n="header_preview">Page Preview</h2>
                    <span id="current-preview-name" class="text-xs px-2 py-1 bg-white border rounded text-slate-500 hidden"></span>
                </div>
                <span class="text-xs text-slate-400" data-i18n="hint_preview">Click page to add to instructions</span>
            </div>

            <div id="preview-area" class="flex-1 p-6 overflow-y-auto custom-scroll grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 content-start">
                <div class="col-span-full h-64 flex flex-col items-center justify-center text-slate-300">
                    <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span class="text-sm" data-i18n="empty_preview">Please add files to begin</span>
                </div>
            </div>
            
            <div id="loading-overlay" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex flex-col items-center justify-center hidden">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-3"></div>
                <span class="text-sm font-medium text-slate-600" data-i18n="msg_parsing">Parsing PDF...</span>
            </div>
        </div>
    </div>

    <script>
        // --- Internationalization (i18n) ---
        let currentLang = 'en'; // Default English

        const translations = {
            en: {
                title: "PDF Master Workshop",
                tag_local: "Client-side Only",
                subtitle: "Multi-file mixing ¬∑ Real-time preview ¬∑ Privacy focused",
                btn_add: "Add PDF Files",
                header_sources: "Source Files (Click to Preview)",
                empty_list: "Please add PDF files<br>from the top right button",
                label_instruction: "Layout Instructions",
                action_clear: "Clear",
                placeholder_instr: "e.g. A1-3; B1; A5,B2",
                guide_title: "Syntax Guide:",
                guide_semicolon: "Semicolon: Separates output files (ZIP mode)",
                guide_range: "Pages 1-5 of File A",
                guide_example: "Ex: A1-3; B1 (Creates 2 parts)",
                mode_merge: "Merge to Single PDF",
                mode_merge_desc: "Ignore semicolons, combine all",
                mode_split: "Split by Semicolon (ZIP)",
                mode_split_desc: "Each group becomes a file",
                placeholder_filename: "Filename Prefix (Optional)",
                btn_process: "Start Processing",
                header_preview: "Page Preview",
                hint_preview: "Click page to add to instructions",
                empty_preview: "Please add files to begin",
                msg_parsing: "Parsing PDF...",
                msg_files_count: "files",
                msg_pages: "pages",
                msg_loading_error: "Failed to load",
                msg_rendering: "Rendering preview...",
                msg_limited_preview: "(Preview limited to first 50 pages)",
                msg_processing: "Processing...",
                msg_success: "Success! Download started",
                msg_error: "Error:",
                msg_no_files: "Please add PDF files first",
                msg_no_input: "Please enter instructions (e.g. A1-5)",
                msg_no_pages: "No valid pages generated. Check your range.",
                preview_current: "Previewing: File"
            },
            zh: {
                title: "PDF Ë∂ÖÁ∫ßÂ∑•Âùä",
                tag_local: "Á∫ØÊú¨Âú∞Â§ÑÁêÜ",
                subtitle: "Â§öÊñá‰ª∂Ê∑∑Êéí ¬∑ ÂÆûÊó∂È¢ÑËßà ¬∑ ÈöêÁßÅÂÆâÂÖ®",
                btn_add: "Ê∑ªÂä† PDF Êñá‰ª∂",
                header_sources: "Êñá‰ª∂Êù•Ê∫ê (ÁÇπÂáªÂàáÊç¢È¢ÑËßà)",
                empty_list: "ËØ∑ÁÇπÂáªÂè≥‰∏äËßíÊåâÈíÆ<br>Ê∑ªÂä† PDF Êñá‰ª∂",
                label_instruction: "ÊéíÁâàÊåá‰ª§",
                action_clear: "Ê∏ÖÁ©∫",
                placeholder_instr: "‰æãÂ¶Ç: A1-3; B1; A5,B2",
                guide_title: "ËØ≠Ê≥ïËØ¥Êòé:",
                guide_semicolon: "ÂàÜÂè∑ÔºöÁî®‰∫éÂàÜÈöî‰∏çÂêåÁöÑËæìÂá∫Êñá‰ª∂ (ÊâìÂåÖZIPÊó∂)",
                guide_range: "‰ª£Ë°®Êñá‰ª∂ A ÁöÑ 1-5 È°µ",
                guide_example: "Á§∫‰æã: A1-3; B1 (ÁîüÊàê2‰∏™ÈÉ®ÂàÜ)",
                mode_merge: "ÂêàÂπ∂‰∏∫‰∏Ä‰∏™ PDF",
                mode_merge_desc: "ÂøΩÁï•ÂàÜÂè∑ÔºåÂÖ®ÈÉ®ËøûÊé•",
                mode_split: "ÊåâÂàÜÂè∑ÊãÜÂàÜ (ZIP)",
                mode_split_desc: "ÊØè‰∏™ÂàÜÂè∑Â≠ò‰∏∫‰∏Ä‰∏™Êñá‰ª∂",
                placeholder_filename: "Êñá‰ª∂ÂêçÂâçÁºÄ (ÂèØÈÄâ)",
                btn_process: "ÂºÄÂßãÂ§ÑÁêÜ",
                header_preview: "È°µÈù¢È¢ÑËßà",
                hint_preview: "ÁÇπÂáªÈ°µÈù¢Ê∑ªÂä†Âà∞Êåá‰ª§Ê°Ü",
                empty_preview: "ËØ∑ÂÖàÊ∑ªÂä†Êñá‰ª∂‰ª•ÂºÄÂßã",
                msg_parsing: "Ê≠£Âú®Ëß£Êûê PDF...",
                msg_files_count: "‰∏™Êñá‰ª∂",
                msg_pages: "È°µ",
                msg_loading_error: "Âä†ËΩΩÂ§±Ë¥•",
                msg_rendering: "Ê≠£Âú®Ê∏≤ÊüìÈ¢ÑËßà...",
                msg_limited_preview: "(‰∏∫‰∫ÜÊÄßËÉΩÔºå‰ªÖÊòæÁ§∫Ââç 50 È°µ)",
                msg_processing: "Â§ÑÁêÜ‰∏≠...",
                msg_success: "Â§ÑÁêÜÊàêÂäüÔºÅ‰∏ãËΩΩÂ∑≤ÂºÄÂßã",
                msg_error: "Âá∫Èîô:",
                msg_no_files: "ËØ∑ÂÖàÊ∑ªÂä† PDF Êñá‰ª∂",
                msg_no_input: "ËØ∑ËæìÂÖ•ÊéíÁâàÊåá‰ª§ (‰æãÂ¶Ç A1-5)",
                msg_no_pages: "Ê≤°ÊúâÁîüÊàêÊúâÊïàÈ°µÈù¢ÔºåËØ∑Ê£ÄÊü•È°µÁ†ÅËåÉÂõ¥",
                preview_current: "ÂΩìÂâçÈ¢ÑËßà: Êñá‰ª∂"
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            applyLanguage();
            // Refresh dynamic lists to update text
            renderFileList();
            if(appState.currentPreviewId !== null) switchPreview(appState.currentPreviewId);
        }

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function applyLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.innerHTML = t(key);
            });
            document.getElementById('page-range').placeholder = t('placeholder_instr');
            document.getElementById('custom-filename').placeholder = t('placeholder_filename');
        }

        // --- Global State ---
        const appState = {
            files: [], // { id: 'A', name: 'xxx', bytes: ArrayBuffer, pdfDoc: Proxy, pageCount: 10 }
            nextIdIndex: 0,
            currentPreviewId: null
        };

        const ID_CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

        // --- DOM Elements ---
        const els = {
            fileInput: document.getElementById('file-input'),
            fileList: document.getElementById('file-list'),
            previewArea: document.getElementById('preview-area'),
            previewName: document.getElementById('current-preview-name'),
            pageRange: document.getElementById('page-range'),
            processBtn: document.getElementById('process-btn'),
            statusMsg: document.getElementById('status-msg'),
            loading: document.getElementById('loading-overlay'),
            fileCount: document.getElementById('file-count'),
            customFilename: document.getElementById('custom-filename')
        };

        // --- File Handling ---
        els.fileInput.addEventListener('change', async (e) => {
            if (!e.target.files.length) return;
            els.loading.classList.remove('hidden');
            
            try {
                for (let file of e.target.files) {
                    if (file.type !== 'application/pdf') continue;
                    await addFile(file);
                }
            } catch (err) {
                console.error(err);
                alert(t('msg_loading_error'));
            } finally {
                els.loading.classList.add('hidden');
                els.fileInput.value = ''; 
            }
        });

        async function addFile(file) {
            const idChar = ID_CHARS[appState.nextIdIndex % ID_CHARS.length]; 
            
            const fileObj = {
                id: idChar,
                realId: appState.nextIdIndex,
                name: file.name,
                bytes: null,
                pdfDoc: null,
                pageCount: 0
            };

            const arrayBuffer = await file.arrayBuffer();
            fileObj.bytes = arrayBuffer;

            try {
                const loadingTask = pdfjsLib.getDocument(new Uint8Array(arrayBuffer));
                fileObj.pdfDoc = await loadingTask.promise;
                fileObj.pageCount = fileObj.pdfDoc.numPages;
                
                appState.files.push(fileObj);
                appState.nextIdIndex++;
                
                renderFileList();
                
                if (appState.files.length === 1) {
                    switchPreview(fileObj.realId);
                }
            } catch (e) {
                console.error("Error loading PDF", file.name, e);
                showStatus(`${t('msg_loading_error')} ${file.name}`, "text-red-500");
            }
        }

        function renderFileList() {
            els.fileList.innerHTML = '';
            els.fileCount.textContent = `${appState.files.length} ${t('msg_files_count')}`;

            if(appState.files.length === 0) {
                els.fileList.innerHTML = `<div class="text-center text-slate-400 py-10 text-sm">${t('empty_list')}</div>`;
                return;
            }

            appState.files.forEach(file => {
                const div = document.createElement('div');
                const isActive = appState.currentPreviewId === file.realId;
                
                div.className = `file-item p-3 rounded-lg border border-slate-200 cursor-pointer flex items-center justify-between group hover:border-blue-400 transition-colors bg-white ${isActive ? 'active ring-1 ring-blue-500' : ''}`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 font-bold flex items-center justify-center shrink-0 border border-slate-200 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                            ${file.id}
                        </div>
                        <div class="flex flex-col overflow-hidden">
                            <span class="text-sm font-medium text-slate-700 truncate" title="${file.name}">${file.name}</span>
                            <span class="text-[10px] text-slate-400">${file.pageCount} ${t('msg_pages')}</span>
                        </div>
                    </div>
                `;
                
                div.onclick = () => switchPreview(file.realId);
                els.fileList.appendChild(div);
            });
        }

        async function switchPreview(realId) {
            const file = appState.files.find(f => f.realId === realId);
            if (!file) return;

            appState.currentPreviewId = realId;
            renderFileList(); 

            els.previewName.textContent = `${t('preview_current')} [${file.id}] ${file.name}`;
            els.previewName.classList.remove('hidden');
            els.previewArea.innerHTML = ''; 

            showStatus(t('msg_rendering'), "text-blue-500");
            
            const limit = Math.min(file.pageCount, 50);
            
            const fragment = document.createDocumentFragment();

            for (let i = 1; i <= limit; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = "page-card bg-white border border-slate-200 p-2 rounded cursor-pointer relative group flex flex-col items-center";
                wrapper.title = `Add: ${file.id}${i}`;
                
                wrapper.onclick = () => addToInput(file.id, i);

                const canvas = document.createElement('canvas');
                canvas.className = "w-full h-auto shadow-sm mb-2 bg-slate-100";
                
                const label = document.createElement('div');
                label.className = "text-xs font-bold text-slate-500 group-hover:text-blue-600";
                label.textContent = `${file.id} - ${i}`;

                wrapper.appendChild(canvas);
                wrapper.appendChild(label);
                fragment.appendChild(wrapper);

                file.pdfDoc.getPage(i).then(page => {
                    const viewport = page.getViewport({ scale: 0.25 });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const ctx = canvas.getContext('2d');
                    page.render({ canvasContext: ctx, viewport: viewport });
                });
            }

            els.previewArea.appendChild(fragment);
            
            if (file.pageCount > limit) {
                const more = document.createElement('div');
                more.className = "col-span-full text-center text-xs text-slate-400 py-4";
                more.textContent = t('msg_limited_preview');
                els.previewArea.appendChild(more);
            }
            showStatus("", "");
        }

        function addToInput(fileId, pageNum) {
            const current = els.pageRange.value;
            const trimmed = current.trim();
            let separator = ", ";
            if (trimmed === "" || trimmed.endsWith(";")) separator = "";
            else if (trimmed.endsWith(",")) separator = " ";
            
            els.pageRange.value = current + separator + `${fileId}${pageNum}`;
        }

        function clearInput() {
            els.pageRange.value = '';
        }

        function showStatus(msg, color) {
            els.statusMsg.textContent = msg;
            els.statusMsg.className = `text-center text-xs mt-2 min-h-[1.5em] font-medium ${color}`;
        }

        // --- Core Processing Logic (Same as before) ---
        els.processBtn.onclick = async () => {
            if (appState.files.length === 0) return alert(t('msg_no_files'));
            const rawInput = els.pageRange.value.trim();
            if (!rawInput) return alert(t('msg_no_input'));

            const originalBtnText = els.processBtn.innerHTML;
            els.processBtn.disabled = true;
            els.processBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${t('msg_processing')}`;

            try {
                const { PDFDocument } = PDFLib;
                const mode = document.querySelector('input[name="mode"]:checked').value;
                const prefix = els.customFilename.value.trim() || "Output";

                let groupStrings = [];
                if (mode === 'merge') {
                    groupStrings = [rawInput.replace(/;/g, ',')]; 
                } else {
                    groupStrings = rawInput.split(';');
                }

                const zip = new JSZip();
                let resultCount = 0;
                let singlePdfBytes = null;

                const loadedDocs = {};
                for (let f of appState.files) {
                    loadedDocs[f.id] = await PDFDocument.load(f.bytes, { ignoreEncryption: true });
                }

                for (let i = 0; i < groupStrings.length; i++) {
                    const groupStr = groupStrings[i].trim();
                    if (!groupStr) continue;

                    const instructions = parseInstruction(groupStr);
                    if (instructions.length === 0) continue;

                    const newPdf = await PDFDocument.create();

                    for (let instr of instructions) {
                        const srcDoc = loadedDocs[instr.fileId];
                        if (!srcDoc) throw new Error(`ID Not Found: ${instr.fileId}`);
                        
                        const validIndices = instr.indices.filter(idx => idx >= 0 && idx < srcDoc.getPageCount());
                        
                        if (validIndices.length > 0) {
                            const copiedPages = await newPdf.copyPages(srcDoc, validIndices);
                            copiedPages.forEach(p => newPdf.addPage(p));
                        }
                    }

                    if (newPdf.getPageCount() === 0) continue;

                    const pdfBytes = await newPdf.save();

                    if (mode === 'merge') {
                        singlePdfBytes = pdfBytes;
                        resultCount = 1;
                    } else {
                        const partName = `${prefix}_Part${(resultCount + 1).toString().padStart(2, '0')}.pdf`;
                        zip.file(partName, pdfBytes);
                        resultCount++;
                    }
                }

                if (resultCount === 0) throw new Error(t('msg_no_pages'));

                if (mode === 'merge') {
                    saveAs(new Blob([singlePdfBytes], { type: "application/pdf" }), `${prefix}_Merged.pdf`);
                } else {
                    const zipContent = await zip.generateAsync({ type: "blob" });
                    saveAs(zipContent, `${prefix}_Split_Files.zip`);
                }

                showStatus(t('msg_success'), "text-green-600");

            } catch (err) {
                console.error(err);
                alert(`${t('msg_error')} ${err.message}`);
                showStatus(`${t('msg_error')} ${err.message}`, "text-red-500");
            } finally {
                els.processBtn.disabled = false;
                els.processBtn.innerHTML = `<span>${t('btn_process')}</span>`;
            }
        };

        function parseInstruction(str) {
            const results = [];
            const parts = str.split(/[,Ôºå]/);

            let defaultId = appState.files.length > 0 ? appState.files[0].id : 'A';

            parts.forEach(part => {
                part = part.trim();
                if (!part) return;

                const match = part.match(/^([A-Za-z]+)?\s*(\d+)(?:\s*-\s*(\d+))?$/);
                
                if (match) {
                    let fileId = match[1] ? match[1].toUpperCase() : defaultId;
                    defaultId = fileId; 

                    const start = parseInt(match[2]);
                    const end = match[3] ? parseInt(match[3]) : start;
                    
                    const indices = [];
                    if (!isNaN(start)) {
                         const step = start <= end ? 1 : -1;
                         for (let n = start; n !== end + step; n += step) {
                             indices.push(n - 1); 
                         }
                    }

                    results.push({ fileId, indices });
                }
            });
            return results;
        }

        // Initialize Language
        applyLanguage();
    </script>
</body>
</html>
